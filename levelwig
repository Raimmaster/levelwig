#!/usr/bin/env python3

import datetime
import functools
import getpass
from os import path
import re
import sys

from pigwig import PigWig, Response
from pigwig.exceptions import HTTPException

import db
import gen

levelwig_dir = path.normpath(path.dirname(path.abspath(__file__)))
template_dir = path.join(levelwig_dir, 'templates')

LOGIN_TIME = datetime.timedelta(days=30)

def routes():
	return [
		('GET', '/', root),
		('GET', '/post/<id>', post),
		('GET', '/post/<id>/<slug>', post),
		('GET', '/login', login_form),
		('POST', '/login', login),
		('GET', '/admin', admin),
		('POST', '/admin/post', admin_post),
		('POST', '/admin/post/<id>/draft', admin_post_draft),
	]

def root(request):
	posts = db.iter_posts(allowed_flags=0)
	logged_in = False
	if request.get_secure_cookie('username', LOGIN_TIME):
		logged_in = True

	return Response.render(request, 'root.jinja2', {'posts': posts, 'logged_in': logged_in})

def post(request, id, slug=None):
	post = db.get_post(id, allowed_flags=db.PostFlag.draft)
	if post is None:
		raise HTTPException(404, 'invalid post id')
	flags, username, title, body = post
	return Response.render(request, 'post.jinja2', {
		'flags': flags, 'username': username, 'title': title, 'body': body,
	})

def login_form(request):
	return Response.render(request, 'login.jinja2', {})

def login(request):
	try:
		username = request.body['username']
		password = request.body['password']
	except KeyError:
		raise HTTPException(400, 'username or password missing')
	if db.check_login(username, password):
		response = Response(code=303, location='/admin')
		response.set_secure_cookie(request, 'username', username, max_age=LOGIN_TIME)
		return response
	else:
		raise HTTPException(401, 'incorrect username or password')

def authed(f):
	@functools.wraps(f)
	def wrapper(request, **kwargs):
		username = request.get_secure_cookie('username', LOGIN_TIME)
		if not username:
			return Response(code=303, location='/login')
		return f(request, username, **kwargs)
	return wrapper

@authed
def admin(request, username):
	posts = db.iter_posts(allowed_flags=db.PostFlag.draft)
	return Response.render(request, 'admin.jinja2', {'posts': posts})

@authed
def admin_post(request, username):
	try:
		title = request.body['title']
		body = request.body['body']
	except KeyError:
		raise HTTPException(400, 'title or body missing')
	db.create_post(username, title, body)
	return Response(code=303, location='/admin')

@authed
def admin_post_draft(request, username, id):
	try:
		status = bool(int(request.body['status']))
	except (KeyError, ValueError):
		raise HTTPException(400, 'invalid status')
	db.toggle_post_flag(id, db.PostFlag.draft, status)
	return Response(code=303, location='/admin')

disallowed_chars_re = re.compile('[^\w\s-]')
dash_chars_re = re.compile('[-\s]+')
def slug(title):
	r = disallowed_chars_re.sub('', title)
	return dash_chars_re.sub('-', r)

app = PigWig(routes, template_dir=template_dir, cookie_secret=b'this is super secret')
app.template_engine.jinja_env.filters['slug'] = slug

def main():
	arg = sys.argv[1]
	if not db.has_users():
		print('time to create your blogwig user!')
		username = input('username: ')
		password = getpass.getpass('password: ')
		db.create_user(username, password)
	if arg == 'dev':
		app.main(port=8000)
	elif arg == 'gen':
		gen.generate(app)

if __name__ == '__main__':
	main()
